From 58c2dc396170e2c84849052a338e2b5d2abc9d51 Mon Sep 17 00:00:00 2001
From: christos <christos>
Date: Tue, 8 Mar 2016 15:45:26 +0000
Subject: [PATCH 1/5] PR/526: David Kaspar: Quote backslashes properly so that
 they can be preserved in `` expansions.

---
 sh.glob.c | 4 +++-
 sh.lex.c  | 2 +-
 2 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/sh.glob.c b/sh.glob.c
index bf4a5ac..fb07657 100644
--- a/sh.glob.c
+++ b/sh.glob.c
@@ -874,7 +874,9 @@ backeval(struct blk_buf *bb, struct Strbuf *word, Char *cp, int literal)
 	    if (!quoted && (c == ' ' || c == '\t'))
 		break;
 	    cnt++;
-	    Strbuf_append1(word, c | quoted);
+	    if (c == '\\' || quoted)
+		c |= QUOTE;
+	    Strbuf_append1(word, c);
 	}
 	/*
 	 * Unless at end-of-file, we will form a new word here if there were
diff --git a/sh.lex.c b/sh.lex.c
index 34c5c09..2bb7db8 100644
--- a/sh.lex.c
+++ b/sh.lex.c
@@ -386,7 +386,7 @@ loop:
 			     */
 			    c |= QUOTE;
 			ungetC(c);
-			c = '\\';
+			c = '\\' | QUOTE;
 		    }
 		}
 	    }
-- 
2.5.5


From 82b96b19acb8269a07fcc86c547614c08c4a58a7 Mon Sep 17 00:00:00 2001
From: christos <christos>
Date: Fri, 13 May 2016 15:08:12 +0000
Subject: [PATCH 2/5] PR/526: Now that backslashes are quoted, we don't need to
 handle them specially here. Fixes echo '\n'<enter><ctrl-p> displaying echo
 '\\n'.

---
 tc.func.c | 3 +--
 1 file changed, 1 insertion(+), 2 deletions(-)

diff --git a/tc.func.c b/tc.func.c
index b13fe04..cdc3aa8 100644
--- a/tc.func.c
+++ b/tc.func.c
@@ -120,8 +120,7 @@ expand_lex(const struct wordent *sp0, int from, int to)
 		if ((*s & QUOTE)
 		    && (((*s & TRIM) == HIST && HIST != '\0') ||
 			(((*s & TRIM) == '\'') && (prev_c != '\\')) ||
-			(((*s & TRIM) == '\"') && (prev_c != '\\')) ||
-			(((*s & TRIM) == '\\') && (prev_c != '\\')))) {
+			(((*s & TRIM) == '\"') && (prev_c != '\\')))) {
 		    Strbuf_append1(&buf, '\\');
 		}
 		Strbuf_append1(&buf, *s & TRIM);
-- 
2.5.5


From 5d7bf499d24b3e44d5d4e0e15be2153d6b67742e Mon Sep 17 00:00:00 2001
From: christos <christos>
Date: Tue, 24 May 2016 19:29:19 +0000
Subject: [PATCH 3/5] set myvar=`\echo 1 2 3` and set myvar=`echo 1 2 3` should
 produce the same result for: $ echo ${myvar[1]} 1

Don't treat the first character of the string specially. If the whole string
is quoted, then we are quoted, otherwise not.
---
 sh.glob.c | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/sh.glob.c b/sh.glob.c
index fb07657..353d1da 100644
--- a/sh.glob.c
+++ b/sh.glob.c
@@ -703,7 +703,12 @@ backeval(struct blk_buf *bb, struct Strbuf *word, Char *cp, int literal)
 
     hadnl = 0;
     icnt = 0;
-    quoted = (literal || (cp[0] & QUOTE)) ? QUOTE : 0;
+    if (!literal) {
+	for (ip = cp; (*ip & QUOTE) != 0; ip++)
+		continue;
+	quoted = *ip == '\0';
+    } else
+	quoted = literal;
     faket.t_dtyp = NODE_COMMAND;
     faket.t_dflg = F_BACKQ;
     faket.t_dlef = 0;
-- 
2.5.5


From 7689ad6d71a2a054dee28caf24b90cec8b46b91a Mon Sep 17 00:00:00 2001
From: christos <christos>
Date: Fri, 27 May 2016 18:07:58 +0000
Subject: [PATCH 4/5] Add a couple of test for PR/526 (David Kaspar)

---
 tests/lexical.at | 59 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++
 1 file changed, 59 insertions(+)

diff --git a/tests/lexical.at b/tests/lexical.at
index f5b1b0f..b04b048 100644
--- a/tests/lexical.at
+++ b/tests/lexical.at
@@ -544,3 +544,62 @@ arg1 arg2
 ])
 
 AT_CLEANUP
+
+
+AT_SETUP([Quoting of expansions in `...`])
+
+AT_DATA([batchsystem.properties],
+[[# Path to job setting file
+asyncjobinfo.uri=file:///usr/bns/stbns01/batch/app/properties/asyncjobinfo.xml
+purebatchjobinfo.uri=file:///usr/bns/stbns01/batch/app/properties/purebatchjobinfo.xml
+
+# DB connection info
+jdbc_url=jdbc:oracle:thin:@(DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=db)(PORT=1521))(CONNECT_DATA=(SERVER=DEDICATED)(SERVICE_NAME=bns03)))
+sub_url=jdbc:oracle:thin:@(DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=db)(PORT=1521))(CONNECT_DATA=(SERVER=DEDICATED)(SERVICE_NAME=bns03)))
+mss_url=jdbc:oracle:thin:@(DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=db)(PORT=1521))(CONNECT_DATA=(SERVER=DEDICATED)(SERVICE_NAME=bns03)))
+dbuser=stbns01bt
+dbpasswd=stbns01bt
+
+# OnBatch listener
+run=3
+]])
+AT_DATA([uniformity_test.csh],
+[[
+set SERVICE_NAME_LOG = `cat batchsystem.properties | grep '^jdbc_url' | sed -ne 's/^[^=]*=[^@]*@[:blank:]*\([^$]*\)$/\1/p' | perl -pe 's/\s//g'  |  perl -pe 's/\)/\\\)/g' | perl -pe 's/\(/\\\(/g'`
+echo -n "$SERVICE_NAME_LOG" > ./output1
+
+cat batchsystem.properties | grep '^jdbc_url' | sed -ne 's/^[^=]*=[^@]*@[:blank:]*\([^$]*\)$/\1/p' | perl -pe 's/\s//g'  |  perl -pe 's/\)/\\\)/g' | perl -pe 's/\(/\\\(/g' > ./output2
+
+diff -uprN ./output1 ./output2 >& /dev/null
+
+if ( $? != 0 ) then
+  echo -n 'FAIL: tcsh does not have uniform output when `...` is used!'
+  exit 1
+else
+  echo -n 'OK'
+  exit 0
+endif
+]])
+AT_DATA([quoting_result_test.csh],
+[[
+echo "(DESCRIPTION=(ADDRESS=(PROTOCOL=TCP\)(HOST=db\)(PORT=1521\)\)(CONNECT_DATA=(SERVER=DEDICATED\)(SERVICE_NAME=bns03\)\)\)" > ./expected_result
+
+set string = "jdbc_url=jdbc:oracle:thin:@(DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=db)(PORT=1521))(CONNECT_DATA=(SERVER=DEDICATED)(SERVICE_NAME=bns03)))"
+set SERVICE_NAME_LOG  = `echo "$string" | grep '^jdbc_url' | sed -ne 's/^[^=]*=[^@]*@[:blank:]*\([^$]*\)$/\1/p' | perl -pe 's/\)/\\\)/g'`
+
+echo "$SERVICE_NAME_LOG" > ./actual_result
+
+diff -uprN ./expected_result ./actual_result >& /dev/null
+
+if ( $? != 0 ) then
+  echo -n 'FAIL: tcsh has unexpected result when `...` is used!'
+  exit 1
+else
+  echo -n 'OK'
+  exit 0
+endif
+]])
+AT_CHECK([tcsh -f uniformity_test.csh], 0,[OK])
+AT_CHECK([tcsh -f quoting_result_test.csh], 0, [OK])
+
+AT_CLEANUP
-- 
2.5.5


From 6deb4fbbdc1ebee4dc83c89ceab8e08353016f56 Mon Sep 17 00:00:00 2001
From: christos <christos>
Date: Fri, 27 May 2016 18:10:15 +0000
Subject: [PATCH 5/5] Test that in backquote expansions quoting just the first
 character does not assume that the whole string is quoted (David Kaspar)

---
 tests/lexical.at | 21 +++++++++++++++++++++
 1 file changed, 21 insertions(+)

diff --git a/tests/lexical.at b/tests/lexical.at
index b04b048..311d426 100644
--- a/tests/lexical.at
+++ b/tests/lexical.at
@@ -603,3 +603,24 @@ AT_CHECK([tcsh -f uniformity_test.csh], 0,[OK])
 AT_CHECK([tcsh -f quoting_result_test.csh], 0, [OK])
 
 AT_CLEANUP
+
+AT_SETUP([\echo for git_tcsh_completion])
+
+AT_DATA([escape_echo.csh],
+[[
+set myvar = `\echo "1 2 3"`
+echo ${myvar}
+echo ${myvar[1]}
+echo ${myvar[2]}
+echo ${myvar[3]}
+exit 0
+]])
+
+AT_CHECK([tcsh -f escape_echo.csh], 0,
+[1 2 3
+1
+2
+3
+])
+
+AT_CLEANUP
-- 
2.5.5

