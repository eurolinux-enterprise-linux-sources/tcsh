From 39fa94267b7eee36daa1f0b76cff0a0967791233 Mon Sep 17 00:00:00 2001
From: christos <christos>
Date: Tue, 8 Mar 2016 15:45:26 +0000
Subject: [PATCH 1/1] PR/526: David Kaspar: Quote backslashes properly so that
 they can be preserved in `` expansions.

---
 sh.glob.c | 4 +++-
 sh.lex.c  | 2 +-
 2 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/sh.glob.c b/sh.glob.c
index 0241a01..04f2040 100644
--- a/sh.glob.c
+++ b/sh.glob.c
@@ -868,7 +868,9 @@ backeval(struct blk_buf *bb, struct Strbuf *word, Char *cp, int literal)
 	    if (!quoted && (c == ' ' || c == '\t'))
 		break;
 	    cnt++;
-	    Strbuf_append1(word, c | quoted);
+	    if (c == '\\' || quoted)
+		c |= QUOTE;
+	    Strbuf_append1(word, c);
 	}
 	/*
 	 * Unless at end-of-file, we will form a new word here if there were
diff --git a/sh.lex.c b/sh.lex.c
index 355a868..56782a0 100644
--- a/sh.lex.c
+++ b/sh.lex.c
@@ -386,7 +386,7 @@ loop:
 			     */
 			    c |= QUOTE;
 			ungetC(c);
-			c = '\\';
+			c = '\\' | QUOTE;
 		    }
 		}
 	    }
-- 
2.5.0

